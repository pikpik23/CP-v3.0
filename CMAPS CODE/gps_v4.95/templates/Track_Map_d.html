<!doctype html>

<html lang="en">
	<head>
		<link rel="stylesheet" type="text/css" href="/static/new/cmaps_css.css">
		<link rel="icon" type="image/png" href="/static/new/images/favicon.ico">
	
		<meta name="viewport" content="width=device-width, initial-scale=1">
	
		<!--JQuery-->
		<script src="/static/js/jquery-1.11.3.min.js"></script>
	
		<!--Conversion from MGRS to Lat/Long-->
		<script src="/static/js/geodesy/vector3d.js"></script>
		<script src="/static/js/geodesy/latlon-ellipsoidal.js"></script>
		<script src="/static/js/geodesy/utm.js"></script>
		<script src="/static/js/geodesy/dms.js"></script>
		<script src="/static/js/geodesy/mgrs.js"></script>
	
		<!--Google Maps Api-->
		<!--<script src="http://maps.googleapis.com/maps/api/js"></script>-->
		<script src="http://maps.googleapis.com/maps/api/js?key=AIzaSyDKx2N9pcck27OYw7z4j--nr6wfHN1M6SM "></script>
	
		<!--Page Styles-->
		<style>
			.customBox {
					background: yellow;
					border: 1px solid black;
					position: absolute;
			}
	
			/* all bellow is css styling for login bar (plz forgive me its messy and inefficient)*/
			::-webkit-input-placeholder { /* Chrome */
				color: #007DC3;
			}
	
			:-ms-input-placeholder { /* IE 10+ */
				color: #007DC3;
			}
	
			::-moz-placeholder { /* Firefox 19+ */
				color: #007DC3;
				opacity: 1;
			}
	
			:-moz-placeholder { /* Firefox 4 - 18 */
				color: #007DC3;
				opacity: 1;
			}
	
			#loginbutton {
				border: 1.5px solid white ;/*#000000*/
				font-size: 16px;
				padding: 10px;
				outline: none;
				width: 250px;
				border-top-right-radius: 10px;
				border-bottom-right-radius: 10px;
				background: white;
				cursor: pointer;
				width: 90px;
				font-weight: bold;
				background-color:white ; /*#999B9E*/
			}
	
			#username {
				border: 2px solid white;/*#000000*/
				font-size: 16px;
				padding: 9px;
				outline: none;
				width: 250px;
				border-top-left-radius: 10px;
				border-bottom-left-radius: 10px;
				background: white;
				width: 200px;
			}
	
			#password {
				border: 2px solid white;/*#000000*/
				font-size: 16px;
				padding: 11.3px;
				outline: none;
				width: 250px;
				border-top: 10px;
				border-bottom: 10px;
				background: white;
				width: 200px;
			}
			/* all above is css styling for login bar (plz forgive me its messy and inefficient)*/
	
			#droplist {
				margin-left: 0px;
				/*border-left: 40px solid white;
				 border-right: 100px solid white;*/
				width: 284px !important;
			}
	
			#settingsContainer {
				color: white;
				font-family: : universltstd;
			}
	
			#setTime {
				cursor: pointer;
				border: 2px solid white;
				font-size: 16px;
				padding: 9px;
				outline: none;
				background: white;
				width: 70px;
				margin-bottom: 10px;
				font-size: 14px;
				font-family: universltstd;
				color: #007DC3;
				border-top-right-radius: 10px;
				border-bottom-right-radius: 10px;
				font-weight: bold;
				margin-top: 10px;
				cursor: pointer;
			}
	
			#lengthTrail {
				border: 2px solid white;/*#000000*/
				font-size: 16px;
				padding: 9px;
				outline: none;
				width: 250px;
				background: white;
				width: 200px;
				margin-bottom: 10px;
				font-size: 14px;
				font-family: universltstd;
				color: #007DC3;
				border-top-left-radius: 10px;
				border-bottom-left-radius: 10px;
				cursor:text;
			}
	
			#gotoButtonL{
				border: 2px solid white;/*#000000*/
				font-size: 16px;
				padding: 9px;
				outline: none;
				width: 250px;
				background: white;
				width: 200px;
				margin-bottom: 10px;
				font-size: 14px;
				font-family: universltstd;
				color: #007DC3;
				border-top-left-radius: 10px;
				border-bottom-left-radius: 10px;
				cursor:text;
			}
	
			#gotoButtonR {
				border: 2px solid white;/*#000000*/
				font-size: 16px;
				padding: 9px;
				outline: none;
				width: 250px;
				background: white;
				width: 200px;
				margin-bottom: 10px;
				font-size: 14px;
				font-family: universltstd;
				color: #007DC3;
				border-top-right-radius: 10px;
				border-bottom-right-radius: 10px;
				cursor:text;
			}
	
			#en {
				border: 2px solid white;/*#000000*/
				font-size: 16px;
				padding: 9px;
				outline: none;
				width: 250px;
				background: white;
				width: 200px;
				margin-bottom: 10px;
				font-size: 14px;
				font-family: universltstd;
				color: #007DC3;
				border-top-left-radius: 10px;
				border-bottom-left-radius: 10px;
				cursor:text;
			}
	
			#seten {
				border: 2px solid white;/*#000000*/
				font-size: 16px;
				padding: 9px;
				outline: none;
				width: 250px;
				background: white;
				width: 200px;
				margin-bottom: 10px;
				font-size: 14px;
				font-family: universltstd;
				color: #007DC3;
				border-top-right-radius: 10px;
				border-bottom-right-radius: 10px;
				cursor:text;
			}
	
		</style>
	
		<title>CMAPS Tracking Map</title>
				
	</head>




	<body background="/static/new/images/patterBG.jpg">

		<div  align="center">
			<header>
				<a href="/">
					<img src="/static/new/images/headerv5.png" width="80%" >   
					<label for="show-menu" class="show-menu">Show Menu</label>
				</a>
			</header>
		</div>
	
		<div align="center" id="menu">
			<input type="checkbox" id="show-menu" role="button">
				<ul>
					<li><a href="/">Home</a></li>
				
					<li><a href="#">Tracking</a>
						<ul class="hidden">
							<li id="droplist"><a href="/track_map/dyn">View Map</a></li>
							<li id="droplist"><a href="/track_database">View Database</a></li>
							<li id="droplist"><a href="/assignments">Assignments</a></li>
						</ul>
					</li>
				
					<li><a href="https://cmaps-wiki.000webhostapp.com/">Wiki</a></li>
				
					<li><a href="http://cmaps.knox.nsw.edu.au/training/cadets">Training</a>
						<ul class="hidden">
							<li id="droplist"><a href="http://cmaps.knox.nsw.edu.au/training/signalers">Signals</a></li>
							<li id="droplist"><a href="http://cmaps.knox.nsw.edu.au/training/operations">Operations</a></li>
							<li id="droplist"><a href="http://cmaps.knox.nsw.edu.au/training/q-store">Q-Store</a></li>
							<li id="droplist"><a href="http://cmaps.knox.nsw.edu.au/training/admin">Admin</a></li>
						</ul>
					</li>
					
				</ul>
		</div>
	
	
		<div style="text-align:center;">
			<h1 style="color:white;font-family:universltstd;">Map</h1>
		
			<!--Checks Username and Password-->
			<form method="post" action="/track_map/dyn" autocomplete="off" style="color:white;font-family:universltstd;margin-bottom:30px;" >
				<input id="username" type="text" name="name" placeholder="Username" style="color:#007DC3;;font-family:universltstd;font-size: 15px;">
				<!--style="background-color:white;color:black;font-family:universltstd;"-->
				<input id="password" type="password" name="password" placeholder="Password" style="color:#007DC3;;font-family:universltstd;font-size: 15px;">
				<input id="loginbutton" type="submit" value="Login" style="color:black;font-family:universltstd;font-size: 15px;color: #007DC3;">
			</form>
		
		
			{% if is_Valid == False %}
		
			<br>
			<br>
			<!--Incorrect Username or Password-->
		
			{% end if %}
			{% if is_Valid == True %}
			<div style="margin-bottom: 100px;font-family:universltstd;">
		
				<!--Map Container-->
				<div id="mainContainer" align="center">
					<div id="googleMap" style="width:100%;height: 650px;margin-bottom: 80px;"></div>
				</div>
			
				<!--Default location buttons-->
				<input id=gotoButtonL style="cursor: pointer;font-weight: bold;" type="button" value="Go to Singleton" onclick="map.panTo(new google.maps.LatLng(-32.74173,151.12997));">
				<input id=gotoButtonR style="cursor: pointer;font-weight: bold;" type="button" value="Go to Knox" onclick="map.panTo(new google.maps.LatLng(-33.72425,151.11586));"> 
			
				<br>
			
				<!--Goto defined location buttons-->
				<p style="font-family: universltstd; color: white;">Grid Reference:</P>
				<p style="font-family: universltstd; color: white;">56HLJ followed by 6 digit GR</p>
				<input id=en style="width: 240px;" type="text" name="mgrs" placeholder="11 digit GR" value="56HLJ">
				<input id=seten style="cursor: pointer;font-weight: bold;" type="button" value="Go to GR">
				
				<!--Sets server variables on trail limits-->
				<form method="post" action="javascript:void(0);" autocomplete="off" onsubmit="" style="color:white;font-family:universltstd;margin-bottom:30px;"> 
					<br>
					<p style="font-family: universltstd; color: white;">Trails</p>
					<input id="lengthTrail" type="text" name="timelim" placeholder="Length of Trail (hours)" style="color:#007DC3;;font-family:universltstd;font-size: 15px;">
					<input id="setTime" type="button" value="Apply" style="color:black;font-family:universltstd;font-size: 15px;color: #007DC3;">    
				</form>
			
				<!--Container for individual trails-->
				<div id="settingsContainer" align="center">
					<div id="checkBoxContainer" align="center"></div>
				</div>
			
				<p style="color: white;font-family: universltstd;">If trails do not appear, uncheck and recheck box</p>
				<p style="color: white;font-family: universltstd;">Trails and settings are still in beta</p>
			</div>
			{% end if %}
							
							
							
		</div>
		
		
	</body>

	<script type="text/javascript">
		var colours = ['#f1f000', '#00099c', '#168000', 'Red', '#ff8801', '#00ffcc']
		//holds the markers from markers.txt
		var markers = [];
		var cms = [];
		var lines = [];
		var UUIDsAllowed = [];
		var map = undefined;
		var mm = undefined;
		var up = function(){
			//Request data
			$.ajax({
				url: "/location/get/all",
				context: document.body
				}).done(function(data) {
						//parse
						var data = JSON.parse(data);
					
					
						//clear previous
						for (var i = 0; i < markers.length; i++) {
							markers[i].setMap(null);
						}
						markers = [];
					
					
						for (var i = 0; i < data.length; i++) {
							//log given data
							console.log(JSON.stringify(data[i]));
							console.log((new Date().getTime() / 1000) - data[i][3]);
						
							//defines coordinates in google data format
							var myLatLng = {lat: data[i][1], lng: data[i][2]};
						
							var h = Math.floor((new Date().getTime() / 3600000) - (data[i][3]/3600))
							var m = Math.round((new Date().getTime() / 60000) - (data[i][3]/60))%60
						
							var t = String("UID: " + data[i][0] + " - last seen " + h + " hours and " + m + " minutes ago")
															
						
							var marker = new google.maps.Marker({
																	position: myLatLng,
																	map: map,
																	title: t
																});
						
							//Old data set format
							/*if (data[i][5] == '1') {
								marker.setIcon('/static/new/images/vehicle1.png');
							} else {
								marker.setIcon('/static/new/images/platoon.png');
							}*/
						
							//Shows activity/inactivity based on last active time
							if (data[1][5] != '1') {
								//Platoon
								//if older that 1800s=0.5h
								if (((new Date().getTime() / 1000) - data[i][3]) > 1800) {
									marker.setIcon('/static/new/images/platoon.png');
								}
								else {
									marker.setIcon('/static/new/images/platoonblue.png');
								}
							}
							else {
								//Vehicle
								//if older that 1800s=0.5h
								if (((new Date().getTime() / 1000) - data[i][3]) > 1800) { 
									marker.setIcon('/static/new/images/vehicle1.png');
								} 
								else {
									marker.setIcon('/static/new/images/vehicleblue.png');
								}
							}
							//Let the next marker be the given marker
							markers[markers.length] = marker;
							markers[markers.length] = new TxtOverlay(new google.maps.LatLng(myLatLng.lat, myLatLng.lng), data[i][4], "customBox", map);
						}
					
					
				});

		};

		var line = function(){
			$.ajax({
				url: "/location/get/polyline",
				context: document.body
				}).done(function(data) {
			
				//Parse
				var data = JSON.parse(data);

				//Clear lines
				for (var i = 0; i < lines.length; i++) {
					lines[i].setMap(null);
				}
				lines = [];
			
				//log given data
				console.log('data=');
				console.log(data);
			
				//for given set of points that defines each line
				for (var i = 0; i < data.length; i++) {
					console.log('i = ' + i.toString());
				
					//Find the filter that corresponds to the data
					var ui = 0;
					for (; ui < UUIDsAllowed.length; ui++) {
						if (UUIDsAllowed[ui][0]==data[i][0][0]) {break;}
					}
				
					//log filter data
					console.log('ui = ' + ui.toString());
					console.log('UUIDsAllowed[ui] = ' + UUIDsAllowed[ui].toString());

					//Skip rendering if this line should be invisible
					if (UUIDsAllowed[ui][1]==false) {continue;}

					//Defines the ordered list of points the line passes through
					var linell = [];
					for (var j = 0 ; j < data[i].length; j++) {
						linell.push(new google.maps.LatLng({lat: data[i][j][1], lng: data[i][j][2]}));
					}
					//Finds the company colour
					var c = colours[(Math.floor((data[i][0][0]/100)-1))%6];
				
					//Creates the polyline with the requested data
					var pline = new google.maps.Polyline({
						path: linell,
						map: map,
						geodesic: true,
						strokeColor: c,
						strokeOpacity: 1.0,
						strokeWeight: 1
					});
					//Saves the variable
					lines.push(pline);

				}

			});


		};

		var staticMarkers = function(){
			//Request data from server
			$.ajax({
				url: "/location/get/sm",
				context: document.body
			}).done(function(data) {
				//Parse
				var data = JSON.parse(data);
				//Create the marker for each marker given
				for (var i = 0; i < data.length; i++) {
			
					var marker = new google.maps.Marker({
						position: new google.maps.LatLng({lat: data[i][1], lng: data[i][2]}),
						map: map,
						title: data[i][0],
						icon: data[i][3]
					});
				
				
					cms.push(marker);
				}
			});

		};
	
		var sh = function(){
			//Iterate until the changed checkbox id is found
			var i = 0;
			for (; i < UUIDsAllowed.length; i++) {
				if (UUIDsAllowed[i][0]==parseInt(this.value)) {
					break;
				}
			}
			//Invert the filter variable for the given trail
			UUIDsAllowed[i][1] = !(UUIDsAllowed[i][1]);
			//Update the trails
			line();
		};
	
		var toggleAll = function(a){
			var nodes = document.getElementById("checkBoxContainer").childNodes;
			for (var i = 0; i < nodes.length; i++) {
				if (nodes[i].type == "checkbox") {
					if (nodes[i].checked == true && a==false) {
						nodes[i].click();
					}
					else if (nodes[i].checked == false && a==true) {
						nodes[i].click();
					}
				}
			}
	
		};
	
	
	
		var genOptions=function(){
			//Request the data from the server
			$.ajax({
					url:"/track_map/dyn/getU",
					context: document.body
					}).done(function(dataIn) {
			
				//Parse the data
				var data = JSON.parse(dataIn);
				//Print data for debug purposes
				console.log(data);
			
				//Clear the previous data
				UUIDsAllowed = [];
			
				//Add the new data for the client side filter
				for (var i = 0; i < data.length; i++) {
					UUIDsAllowed.push([data[i][0],true]);
				}
			
				//Create a reference to the checkbox container
				var container = document.getElementById("checkBoxContainer");
				//Clear the previous content
				container.innerHTML = "";
			
			
				//Create a deep copy of data
				var sortedData = JSON.parse(dataIn);
				//sort by name
				sortedData.sort(function (a,b) {return (a[1]<b[1]?-1:(a[1]>b[1]?1:0))});
			
			
			
				//Iterate through the trails
				for (var i = 0; i < sortedData.length; i++) {
					//Create a checkbox for display of each trail
					var checkbox = document.createElement('input');
					checkbox.type = "checkbox";
					checkbox.name = "enabled";
					checkbox.value = sortedData[i][0].toString();
					checkbox.id = "id";
					checkbox.checked="checked";
					//Define the action on check/uncheck
					checkbox.onchange=sh;
				
					//Attach a label to each checkbox
					var label = document.createElement('label')
					label.htmlFor = "id";
					label.appendChild(document.createTextNode(sortedData[i][1].toString()));
				
					//Create a new line for each visibility box
					container.appendChild(checkbox);
					container.appendChild(label);
					container.appendChild(document.createElement("br"));
				}
			
			
				container.appendChild(document.createElement("br"));
			
			
				var showAllCB = document.createElement('input');
				showAllCB.type = "button";
				showAllCB.name = "enabled";
				showAllCB.value = "Show All";
				showAllCB.id = "id";
				showAllCB.onclick=function(){toggleAll(true);};
			
			
			
				container.appendChild(document.createElement("br"));
			
				var hideAllCB = document.createElement('input');
				hideAllCB.type = "button";
				hideAllCB.name = "enabled";
				hideAllCB.value = "Hide All";
				hideAllCB.id = "id";
				hideAllCB.onclick=function(){toggleAll(false);};
			
				container.appendChild(showAllCB);
				container.appendChild(hideAllCB);
				container.appendChild(document.createElement("br"));
			});
		};

		var convert=function(s){
			//var s=document.getElementById('mgrs').value;
			//Assume the data is given in the form (Zone)2(band)(east)(north)(east)3(north)3 in regex
			var zone = parseInt(s.slice(0, 2));
			var band = s.slice(2,3);
			var e = s.slice(3,4);
			var n = s.slice(4,5);
			var east = parseInt(s.slice(5, 8))*100;
			var north = parseInt(s.slice(8, 11))*100;
		
			//Defines the given data as a MGRS object
			var ll = Mgrs(zone,band,e,n,east,north);
			//Convert to utm
			ll = ll.toUtm();
			//Convert to lat-long
			ll = ll.toLatLonE();
			//return in the form of a 2-element list
			return [ll.lat,ll.lon];
		};

		var setTime=function(){
			//Push the new time limit to the server
			$.ajax({
				   url:"/track_map/dyn/pushT?timelim="+(document.getElementById('lengthTrail').value).toString(),
				   context: document.body,
				   });
			//Generate new trails
			genOptions();
			line();
		};

		var movetoMGRSLoc=function(){
			//Get the coordinates
			var l = document.getElementById('en').value;
		
			if (l != "") {
				//The js conversion files only accepts upper case
				//Converts MGRS to Lat-Long
				var ll = convert(l.toUpperCase());
				//Log the resulting coordinate
				console.log(ll);
			
				//Creates the lat-long as a google maps object
				var lll = new google.maps.LatLng(ll[0],ll[1]);
				//Pan the map to requested position
				map.panTo(lll);
			
				//If existing marker exists, remove the marker from the map
				if (mm) {
					mm.setMap(null);
					console.log('removed');
				}
			
				//Create the new marker with the given coordinates
				mm = new google.maps.Marker({
												position: lll,
												map: map,
												title: document.getElementById('en').value
											});
			
			}
			else { 
				//Removes the marker from the map
				if (mm) {
					mm.setMap(null);
					console.log('removed');
				}
			}
		};


		function initialize() {
			//Singleton coordinates are: -32.74173197678436,151.12997889518738
			//Knox Grammar coordinates are: -33.72425,151.11586
			console.log('Initialise() start');
		
			//Creates the map centred at defined coordinates
			var mapProp = {
				center:new google.maps.LatLng(-32.74173197678436 , 151.12997889518738),
				zoom:14,
				mapTypeId:google.maps.MapTypeId.HYBRID
			};
			//Gets the map object and sets it to a variable
			map = new google.maps.Map(document.getElementById("googleMap") , mapProp);
		
			//Initial generation of both markers defined in markers.txt and the trail visibility checkboxes
			staticMarkers();
			genOptions();
		
			//Defines the action of the set time and set position buttions
			var b = document.getElementById('setTime');
			b.onclick = setTime;
			var c = document.getElementById('seten');
			c.onclick = movetoMGRSLoc;
	
			//Retrieves current positions as well as trail data
			//Initial activation
			up();
			line();
			//Retrieves the data and renders the new data in a set interval
			setInterval("up()", 15000);
			setInterval("line()",60000);
		}

		//adapted from this example http://code.google.com/apis/maps/documentation/javascript/overlays.html#CustomOverlays
		//text overlays
		function TxtOverlay(pos, txt, cls, map) {
	
			// Now initialize all properties.
			this.pos = pos;
			this.txt_ = txt;
			this.cls_ = cls;
			this.map_ = map;
	
			// We define a property to hold the image's
			// div. We'll actually create this div
			// upon receipt of the add() method so we'll
			// leave it null for now.
			this.div_ = null;
	
			// Explicitly call setMap() on this overlay
			this.setMap(map);
		}

		TxtOverlay.prototype = new google.maps.OverlayView();
		TxtOverlay.prototype.onAdd = function() {
	
			// Note: an overlay's receipt of onAdd() indicates that
			// the map's panes are now available for attaching
			// the overlay to the map via the DOM.
	
			// Create the DIV and set some basic attributes.
			var div = document.createElement('DIV');
			div.className = this.cls_;
	
			div.innerHTML = this.txt_;
	
			// Set the overlay's div_ property to this DIV
			this.div_ = div;
			var overlayProjection = this.getProjection();
			var position = overlayProjection.fromLatLngToDivPixel(this.pos);
			div.style.left = position.x + 'px';
			div.style.top = position.y + 'px';
			// We add an overlay to a map via one of the map's panes.
	
			var panes = this.getPanes();
			panes.floatPane.appendChild(div);
		}
		TxtOverlay.prototype.draw = function() {
	
			var overlayProjection = this.getProjection();
	
			// Retrieve the southwest and northeast coordinates of this overlay
			// in latlngs and convert them to pixels coordinates.
			// We'll use these coordinates to resize the DIV.
			var position = overlayProjection.fromLatLngToDivPixel(this.pos);
	
			var div = this.div_;
			div.style.left = position.x + 'px';
			div.style.top = position.y + 'px';
	
		}
	
		//Optional: helper methods for removing and toggling the text overlay.
		TxtOverlay.prototype.onRemove = function() {
			this.div_.parentNode.removeChild(this.div_);
			this.div_ = null;
		}
		TxtOverlay.prototype.hide = function() {
			if (this.div_) {
				this.div_.style.visibility = "hidden";
			}
		}
		TxtOverlay.prototype.show = function() {
			if (this.div_) {
				this.div_.style.visibility = "visible";
			}
		}
		TxtOverlay.prototype.toggle = function() {
			if (this.div_) {
				if (this.div_.style.visibility == "hidden") {
					this.show();
				} 
				else {
					this.hide();
				}
			}
		}
		TxtOverlay.prototype.toggleDOM = function() {
			if (this.getMap()) {
				this.setMap(null);
			} 
			else {
				this.setMap(this.map_);
			}
		}
		google.maps.event.addDomListener(window, 'load', initialize);
	
	</script>
</html>
